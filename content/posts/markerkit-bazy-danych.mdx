---
title: "Makerkit #4 - Bazy Danych. Supabase, RLS i Modelowanie Danych"
description: "Backend to nie tylko API. Naucz siÄ™ projektowaÄ‡ bezpieczne schematy w PostgreSQL, zarzÄ…dzaÄ‡ migracjami w Supabase i pisaÄ‡ zaawansowane polityki RLS, ktÃ³re pilnujÄ… nie tylko dostÄ™pu, ale i limitÃ³w biznesowych Twojego SaaS-a."
date: "2026-02-17"
categories: ["SaaS", "Supabase", "PostgreSQL", "Backend", "Security"]
tags:
  [
    "Supabase",
    "PostgreSQL",
    "RLS",
    "Database",
    "Migrations",
    "Typegen",
    "SQL",
    "RBAC",
  ]
image: "/blog/makerkit.jpg"
imageCaption: "Schemat bazy danych i RLS - fundamenty bezpieczeÅ„stwa SaaS."
featured: false
author:
  name: "zeprzalka.com"
  title: "Digital Solutions Architect"
  bio: "TworzÄ™ rozwiÄ…zania Å‚Ä…czÄ…ce biznes z technologiÄ…."
  avatar: "/avatar.png"
---

Witajcie w czwartym odcinku naszej serii. ğŸ‘‹

Do tej pory bawiliÅ›my siÄ™ gotowymi klockami: konfigurowaliÅ›my kolory, uruchamialiÅ›my kontenery. DziÅ› wchodzimy do kendu i projektujemy **BazÄ™ Danych**.

W Å›wiecie Makerkit (i nowoczesnego Next.js) baza danych to nie tylko "pojemnik na tekst". Supabase (oparty na PostgreSQL) przejmuje na siebie ogromnÄ… czÄ™Å›Ä‡ logiki:

1.  **Relacje** miÄ™dzy danymi (Schema).
2.  **BezpieczeÅ„stwo** (Row Level Security - RLS).
3.  **LogikÄ™ biznesowÄ…** (Functions & Triggers).

Zrozumienie tego jest kluczowe, aby TwÃ³j SaaS byÅ‚ skalowalny i bezpieczny. Zapnijcie pasy, wchodzimy w SQL. ğŸ’¾

## ğŸ”„ Cykl Å»ycia Pracy Developera (The Workflow)

Wielu poczÄ…tkujÄ…cych popeÅ‚nia bÅ‚Ä…d, prÃ³bujÄ…c dokonywaÄ‡ zmian, klikajÄ…c w panelu Supabase w przeglÄ…darce ("Dashboard"). **Nie rÃ³b tego.**
W profesjonalnym projekcie pracujemy lokalnie, uÅ¼ywajÄ…c migracji.

Cykl pracy w Makerkit wyglÄ…da tak:

1.  **Edycja:** Tworzysz plik migracji SQL.
2.  **Reset:** Aplikujesz zmiany do lokalnej bazy (`pnpm run supabase:web:reset`).
3.  **Typegen:** Generujesz typy TypeScript na podstawie bazy (`pnpm run supabase:web:typegen`).
4.  **Kodowanie:** UÅ¼ywasz nowych, w peÅ‚ni otypowanych tabel w Next.js.

DziÄ™ki temu Twoja baza danych jest zawsze zsynchronizowana z kodem, a TypeScript pilnuje, czy nie prÃ³bujesz pobraÄ‡ nieistniejÄ…cej kolumny.

## ğŸ—ï¸ Projektowanie Schematu (Schema Design)

Sercem Makerkita jest tabela `public.accounts`. To ona trzyma wszystko w ryzach.
KaÅ¼dy element Twojego systemu (np. Projekty, Faktury, ZgÅ‚oszenia) musi naleÅ¼eÄ‡ do jakiegoÅ› **Konta** (ktÃ³re moÅ¼e byÄ‡ uÅ¼ytkownikiem indywidualnym LUB zespoÅ‚em).

StwÃ³rzmy przykÅ‚adowy system **TicketÃ³w Supportowych** (to idealny przykÅ‚ad relacji).

### 1. Tworzenie Migracji

W terminalu wpisujemy:

```bash
pnpm --filter web supabase migration new support-schema
```

To utworzy pusty plik SQL w folderze `apps/web/supabase/migrations`.

### 2. Definicja Tabeli

Oto jak wyglÄ…da profesjonalna definicja tabeli w SQL. ZauwaÅ¼ uÅ¼ycie `ENUM` do statusÃ³w â€“ to zapobiega literÃ³wkom w kodzie.

```sql
-- Definiujemy statusy (lepsze niÅ¼ zwykÅ‚y string!)
create type public.ticket_status as enum ('open', 'closed', 'resolved', 'in_progress');

create table if not exists public.tickets (
  id uuid primary key default gen_random_uuid(),
  -- KLUCZOWE: PowiÄ…zanie z kontem (WÅ‚aÅ›cicielem danych)
  account_id uuid not null references public.accounts(id) on delete cascade,
  title varchar(255) not null,
  status public.ticket_status not null default 'open',
  -- Kto stworzyÅ‚/przypisaÅ‚ ticket?
  assigned_to uuid references public.accounts(id) on delete set null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- Indeks przyspiesza wyszukiwanie po koncie (bardzo waÅ¼ne!)
create index ix_tickets_account_id on public.tickets(account_id);
```

## ğŸ›¡ï¸ RLS: TwÃ³j Osobisty Ochroniarz

Teraz najwaÅ¼niejsza czÄ™Å›Ä‡. DomyÅ›lnie w Supabase kaÅ¼dy moÅ¼e zrobiÄ‡ wszystko (jeÅ›li ma klucz API).
Musimy wÅ‚Ä…czyÄ‡ **Row Level Security (RLS)**.

RLS to mechanizm, w ktÃ³rym baza danych sprawdza kaÅ¼dy wiersz przed jego wydaniem. To jak ochroniarz w klubie, ktÃ³ry sprawdza dowÃ³d kaÅ¼demu goÅ›ciowi z osobna.

### Krok 1: Zero Trust (Odbieramy uprawnienia)

Najpierw blokujemy wszystko.

```sql
revoke all on public.tickets from public, service_role;
```

### Krok 2: Otwieramy drzwi dla zalogowanych

```sql
grant select, insert, update, delete on public.tickets to authenticated;
grant select, insert on public.tickets to service_role;
```

### Krok 3: WÅ‚Ä…czamy RLS i Definiujemy PolitykÄ™

PoniÅ¼sza polityka mÃ³wi: _"UÅ¼ytkownik moÅ¼e zobaczyÄ‡ ten bilet TYLKO WTEDY, gdy naleÅ¼y do konta, ktÃ³re jest wÅ‚aÅ›cicielem biletu"_.

```sql
alter table public.tickets enable row level security;

create policy select_tickets
  on public.tickets
  for select
  to authenticated
  using (
    -- Funkcja sprawdzajÄ…ca przynaleÅ¼noÅ›Ä‡
    public.has_role_on_account(account_id)
  );
```

## ğŸ‘®â€â™‚ï¸ Poziom Hard: Granularne Uprawnienia (RBAC)

Makerkit idzie o krok dalej. Co jeÅ›li chcesz, aby **kaÅ¼dy** w firmie widziaÅ‚ tickety, ale tylko **WÅ‚aÅ›ciciel (Owner)** mÃ³gÅ‚ je usuwaÄ‡?
ZwykÅ‚e `has_role_on_account` tu nie wystarczy.

Musimy uÅ¼yÄ‡ systemu uprawnieÅ„ Makerkita (`public.role_permissions`).

1.  **Dodajemy uprawnienie do systemu:**
    ```sql
    alter type public.app_permissions add value 'tickets.delete';
    ```
2.  **Przypisujemy uprawnienie do roli Owner:**
    ```sql
    insert into public.role_permissions(role, permission)
    values ('owner', 'tickets.delete');
    ```
3.  **Tworzymy restrykcyjnÄ… politykÄ™ RLS:**
    ```sql
    create policy delete_tickets
      on public.tickets
      for delete
      to authenticated
      using (
        -- Sprawdzamy nie tylko konto, ale i konkretne uprawnienie!
        public.has_permission(auth.uid(), account_id, 'tickets.delete'::app_permissions)
      );
    ```

To jest poziom Enterprise. DziÄ™ki temu Twoja aplikacja jest gotowa na duÅ¼e firmy, ktÃ³re majÄ… skomplikowane struktury pracownikÃ³w.

## ğŸ§  Logika w Bazie: Funkcje i Triggery

PostgreSQL pozwala na automatyzacjÄ™. Zamiast pisaÄ‡ w kodzie JS "kiedy status zmieni siÄ™ na zamkniÄ™ty, ustaw datÄ™ zamkniÄ™cia", zrÃ³bmy to w bazie. To gwarantuje spÃ³jnoÅ›Ä‡ danych.

Ale moÅ¼emy robiÄ‡ rzeczy znacznie ciekawsze â€“ np. **pilnowanie limitÃ³w planu (Billing)**.
WyobraÅº sobie funkcjÄ™ `check_ticket_limit`, ktÃ³ra uruchamia siÄ™ PRZED dodaniem nowego ticketa:

```sql
create trigger check_ticket_limit
before insert on public.tickets
for each row
execute function public.check_ticket_limit();
```

Taka funkcja (opisana w dokumentacji Makerkit) sprawdza, czy firma ma wykupionÄ… subskrypcjÄ™ i czy nie przekroczyÅ‚a limitu np. 50 ticketÃ³w miesiÄ™cznie. JeÅ›li tak â€“ baza danych odrzuci zapis i zwrÃ³ci bÅ‚Ä…d. BezpieczeÅ„stwo absolutne.

## ğŸŒ± Seeding: Dane na Start

Praca na pustej bazie jest trudna i ciÄ™Å¼ka do zrozumienia (przypomina siÄ™ nauka z ksiÄ…Å¼ek lub wykÅ‚adÃ³w o programowaniu, gdzie poziom abstrakcji pokonuje nawet najbardziej tÄ™gie umysÅ‚y). Makerkit uÅ¼ywa pliku `seed.sql` w folderze `supabase/`, aby wgraÄ‡ dane startowe przy kaÅ¼dym resecie bazy.

Warto dodaÄ‡ tam przykÅ‚adowe tickety:

```sql
INSERT INTO public.tickets (account_id, title, status, priority)
VALUES
  ('id-twojego-konta', 'Problem z logowaniem', 'open', 'high'),
  ('id-twojego-konta', 'BÅ‚Ä…d na fakturze', 'in_progress', 'medium');
```

DziÄ™ki temu po wpisaniu `pnpm run supabase:web:reset`, od razu masz aplikacjÄ™ peÅ‚nÄ… danych do testowania UI.

## âŒ¨ï¸ Typegen: Magia TypeScripta

Po naÅ‚oÅ¼eniu migracji, czas na nagrodÄ™. Uruchamiamy:

```bash
pnpm run supabase:web:typegen
```

Ten skrypt skanuje TwojÄ… lokalnÄ… bazÄ™ Postgres i generuje plik `database.types.ts`. Teraz w kodzie aplikacji Next.js masz peÅ‚ne podpowiadanie typÃ³w. TypeScript wie, Å¼e `status` moÅ¼e byÄ‡ tylko `'open' | 'closed'`, a nie dowolnym stringiem.

## ğŸ’¡ Podsumowanie

Praca z bazÄ… danych w Makerkit to coÅ› wiÄ™cej niÅ¼ `CREATE TABLE`. To budowanie bezpiecznej twierdzy, gdzie:

1.  **Schema** definiuje strukturÄ™ i relacje.
2.  **RLS** i **RBAC** pilnujÄ…, by nikt nie zobaczyÅ‚ (ani nie usunÄ…Å‚!) danych bez uprawnieÅ„.
3.  **Triggery** dbajÄ… o automatyzacjÄ™ i pilnujÄ… limitÃ³w biznesowych (Billing).
4.  **Typegen** spina to wszystko z Twoim frontendem w Next.js.

MajÄ…c tak solidne fundamenty, moÅ¼emy przejÅ›Ä‡ do budowania interfejsu uÅ¼ytkownika, wiedzÄ…c, Å¼e nasze dane sÄ… bezpieczne. ğŸ›¡ï¸

W nastÄ™pnym odcinku zajmiemy siÄ™ **Server Components** i pobieraniem tych danych na frontendzie!

---

**Å¹rÃ³dÅ‚o:** [Makerkit Course - Database Schema and Migrations](https://makerkit.dev/courses/nextjs-turbo/database)
